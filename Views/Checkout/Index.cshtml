@* @model List<BoxBuildproj.Models.Cart> *@
@* @{ *@
@*     ViewData["Title"] = "Checkout"; *@
@* } *@

@* <h2>Checkout</h2> *@

@* <table class="table"> *@
@*     <thead> *@
@*         <tr> *@
@*             <th>Product</th> *@
@*             <th>Price</th> *@
@*             <th>Qty</th> *@
@*             <th>Total</th> *@
@*         </tr> *@
@*     </thead> *@
@*     <tbody> *@
@*         @foreach (var item in Model) *@
@*         { *@
@*             <tr> *@
@*                 <td>@item.Product.ProductName</td> *@
@*                 <td>@item.Product.Price.ToString("C")</td> *@
@*                 <td>@item.Quantity</td> *@
@*                 <td>@(item.Product.Price * item.Quantity).ToString("C")</td> *@
@*             </tr> *@
@*         } *@
@*     </tbody> *@
@* </table> *@

@* <h4>Total: ₹@(ViewBag.TotalAmount / 100)</h4> *@

@* <button id="rzp-button1" class="btn btn-success">Pay Now</button> *@

@* @section Scripts { *@
@*     <script src="https://checkout.razorpay.com/v1/checkout.js"></script> *@
@*     <script> *@
@*         document.getElementById('rzp-button1').onclick = function (e) { *@
@*             fetch('/Checkout/CreateOrder', { *@
@*                 method: 'POST', *@
@*                 headers: { 'Content-Type': 'application/json' }, *@
@*                 body: JSON.stringify({ totalAmount: @ViewBag.TotalAmount }) *@
@*             }) *@
@*             .then(res => res.json()) *@
@*             .then(data => { *@
@*                 var options = { *@
@*                     "key": "rzp_test_hXLdzaZ9MkR9Wf", // Replace with your Razorpay test/live key *@
@*                     "amount": @ViewBag.TotalAmount, *@
@*                     "currency": "INR", *@
@*                     "name": "BoxBuild", *@
@*                     "description": "Purchase Products", *@
@*                     "order_id": data.orderId, *@
@*                     "handler": function (response) { *@
@*                         window.location.href = '/Checkout/PaymentSuccess?paymentId=' + response.razorpay_payment_id; *@
@*                     }, *@
@*                     "prefill": { *@
@*                         "email": "@ViewBag.UserEmail" *@
@*                     }, *@
@*                     "theme": { *@
@*                         "color": "#3399cc" *@
@*                     } *@
@*                 }; *@
@*                 var rzp = new Razorpay(options); *@
@*                 rzp.open(); *@
@*                 e.preventDefault(); *@
@*             }); *@
@*         } *@
@*     </script> *@
@* } *@



@model List<BoxBuildproj.Models.Cart>

@{
    ViewData["Title"] = "Checkout";
    decimal totalAmount = 0;
}
<header style="background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px); box-shadow: 0 8px 24px rgba(0,0,0,0.1);">
    <div class="container py-3">
        <nav class="navbar navbar-expand-lg navbar-light">
            <!-- Logo -->
            <a class="navbar-brand d-flex align-items-center" asp-controller="User" asp-action="Home">
                <img src="~/pillowmart-master/img/logobox.png" asp-append-version="true" alt="logo" style="height: 45px;" />
            </a>

            <!-- Toggler for mobile -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Nav items -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav align-items-center ms-auto" style="gap: 30px; font-weight: 500; font-size: 16px;">
                    <li class="nav-item">
                        <a class="nav-link link-animate" asp-controller="User" asp-action="Home">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link link-animate" asp-controller="User" asp-action="About">About</a>
                    </li>

                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle link-animate" href="#" role="button" data-bs-toggle="dropdown">Product</a>
                        <div class="dropdown-menu dropdown-animated shadow rounded">
                            <a class="dropdown-item" asp-controller="UserProducts" asp-action="Product_list">Product List</a>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle link-animate" href="#" role="button" data-bs-toggle="dropdown">Pages</a>
                        <div class="dropdown-menu dropdown-animated shadow rounded">
                            @if (User.Identity.IsAuthenticated)
                            {
                                <span class="dropdown-item text-muted">Hi, @User.Identity.Name</span>
                                <a class="dropdown-item" asp-controller="Profile" asp-action="Index">My Profile</a>
                                <a class="dropdown-item" asp-controller="Checkout" asp-action="Index">Checkout</a>
                                <a class="dropdown-item" asp-controller="Cart" asp-action="Index">Cart</a>
                                <a class="dropdown-item" asp-controller="Order" asp-action="MyOrders">My Orders</a>
                            }
                            else
                            {
                                <a class="dropdown-item" asp-area="Identity" asp-page="/Account/Login">Login</a>
                                <a class="dropdown-item" asp-area="Identity" asp-page="/Account/Register">Register</a>
                            }
                        </div>
                    </li>

                    @if (User.Identity.IsAuthenticated)
                    {
                        <li class="nav-item">
                            <form method="post" asp-area="Identity" asp-page="/Account/Logout" class="d-inline">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn btn-sm btn-outline-danger">Logout</button>
                            </form>
                        </li>
                    }


                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle link-animate" href="#" role="button" data-bs-toggle="dropdown">Blog</a>
                        <div class="dropdown-menu dropdown-animated shadow rounded">
                            <a class="dropdown-item" asp-controller="Blog" asp-action="Index">Blog</a>
                            <a class="dropdown-item" asp-controller="Blog" asp-action="SingleBlog">Single Blog</a>
                        </div>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link link-animate" asp-controller="Contact" asp-action="Index">Contact</a>
                    </li>

                    <!-- Icons -->

                    <li class="nav-item ms-2">
                        <a asp-controller="Cart" asp-action="Index" class="text-dark icon-animate" style="font-size: 20px;">
                            <i class="flaticon-shopping-cart-black-shape"></i>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>
    </div>
</header>

@* <h2>Checkout</h2> *@

@* <table class="table"> *@
@*     <thead> *@
@*         <tr> *@
@*             <th>Product</th> *@
@*             <th>Price</th> *@
@*             <th>Qty</th> *@
@*             <th>Total</th> *@
@*         </tr> *@
@*     </thead> *@
@*     <tbody> *@
@*         @foreach (var item in Model) *@
@*         { *@
@*             var offer = item.Product.ProductOffer?.FirstOrDefault()?.Offer; *@
@*             decimal price = item.Product.Price; *@

@*             if (offer != null && offer.StartDate <= DateTime.Now && offer.EndDate >= DateTime.Now) *@
@*             { *@
@*                 var discountAmount = (offer.DiscountPercentage / 100m) * price; *@
@*                 price -= discountAmount; *@
@*             } *@

@*             decimal itemTotal = price * item.Quantity; *@
@*             totalAmount += itemTotal; *@

@*             <tr> *@
@*                 <td>@item.Product.ProductName</td> *@
@*                 <td>₹@price.ToString("0.00")</td> *@
@*                 <td>@item.Quantity</td> *@
@*                 <td>₹@itemTotal.ToString("0.00")</td> *@
@*             </tr> *@
@*         } *@
@*     </tbody> *@
@* </table> *@

@* <h4>Total: ₹@totalAmount.ToString("0.00")</h4> *@

@* <button id="rzp-button1" class="btn btn-success">Pay Now</button> *@

@* @section Scripts { *@
@*     <script src="https://checkout.razorpay.com/v1/checkout.js"></script> *@
@*     <script> *@
@*         document.getElementById('rzp-button1').onclick = function (e) { *@
@*             fetch('/Checkout/CreateOrder', { *@
@*                 method: 'POST', *@
@*                 headers: { 'Content-Type': 'application/json' }, *@
@*                 body: JSON.stringify({ totalAmount: @((int)(totalAmount * 100)) }) // convert to paisa *@
@*             }) *@
@*             .then(res => res.json()) *@
@*             .then(data => { *@
@*                 var options = { *@
@*                     "key": "rzp_test_hXLdzaZ9MkR9Wf", // Replace with your Razorpay key *@
@*                     "amount": @((int)(totalAmount * 100)), *@
@*                     "currency": "INR", *@
@*                     "name": "BoxBuild", *@
@*                     "description": "Purchase Products", *@
@*                     "order_id": data.orderId, *@
@*                     "handler": function (response) { *@
@*                         window.location.href = '/Checkout/PaymentSuccess?paymentId=' + response.razorpay_payment_id; *@
@*                     }, *@
@*                     "prefill": { *@
@*                         "email": "@ViewBag.UserEmail" *@
@*                     }, *@
@*                     "theme": { *@
@*                         "color": "#3399cc" *@
@*                     } *@
@*                 }; *@
@*                 var rzp = new Razorpay(options); *@
@*                 rzp.open(); *@
@*                 e.preventDefault(); *@
@*             }); *@
@*         } *@
@*     </script> *@
@* } *@


@* <!-- Checkout Section --> *@
@* <section class="container py-5"> *@
@*     <div class="row justify-content-center"> *@
@*         <div class="col-lg-10"> *@
@*             <div class="card shadow-lg rounded-4"> *@
@*                 <div class="card-header bg-primary text-white rounded-top-4"> *@
@*                     <h3 class="mb-0"><i class="bi bi-credit-card-fill me-2"></i>Checkout</h3> *@
@*                 </div> *@
@*                 <div class="card-body p-4"> *@
@*                     <div class="table-responsive"> *@
@*                         <table class="table table-hover align-middle"> *@
@*                             <thead class="table-light"> *@
@*                                 <tr> *@
@*                                     <th scope="col">Product</th> *@
@*                                     <th scope="col">Price</th> *@
@*                                     <th scope="col">Quantity</th> *@
@*                                     <th scope="col">Total</th> *@
@*                                 </tr> *@
@*                             </thead> *@
@*                             <tbody> *@
@*                                 @foreach (var item in Model) *@
@*                                 { *@
@*                                     var offer = item.Product.ProductOffer?.FirstOrDefault()?.Offer; *@
@*                                     decimal price = item.Product.Price; *@

@*                                     if (offer != null && offer.StartDate <= DateTime.Now && offer.EndDate >= DateTime.Now) *@
@*                                     { *@
@*                                         var discountAmount = (offer.DiscountPercentage / 100m) * price; *@
@*                                         price -= discountAmount; *@
@*                                     } *@

@*                                     decimal itemTotal = price * item.Quantity; *@
@*                                     totalAmount += itemTotal; *@

@*                                     <tr> *@
@*                                         <td> *@
@*                                             <strong>@item.Product.ProductName</strong><br /> *@
@*                                             @if (offer != null && offer.StartDate <= DateTime.Now && offer.EndDate >= DateTime.Now) *@
@*                                             { *@
@*                                                 <small class="text-success">Offer: @offer.DiscountPercentage% off</small> *@
@*                                             } *@
@*                                         </td> *@
@*                                         <td>₹@price.ToString("0.00")</td> *@
@*                                         <td>@item.Quantity</td> *@
@*                                         <td>₹@itemTotal.ToString("0.00")</td> *@
@*                                     </tr> *@
@*                                 } *@
@*                             </tbody> *@
@*                         </table> *@
@*                     </div> *@

@*                     <div class="d-flex justify-content-end mt-4"> *@
@*                         <h4>Total Amount: <span class="text-primary">₹@totalAmount.ToString("0.00")</span></h4> *@
@*                     </div> *@

@*                     <div class="text-end mt-4"> *@
@*                         <button id="rzp-button1" class="btn btn-lg btn-success px-4 shadow-sm"> *@
@*                             <i class="bi bi-wallet2 me-2"></i> Pay Now *@
@*                         </button> *@
@*                     </div> *@
@*                 </div> *@
@*             </div> *@
@*         </div> *@
@*     </div> *@
@* </section> *@

@* @section Scripts { *@
@*     <script src="https://checkout.razorpay.com/v1/checkout.js"></script> *@
@*     <script> *@
@*         document.getElementById('rzp-button1').onclick = function (e) { *@
@*             fetch('/Checkout/CreateOrder', { *@
@*                 method: 'POST', *@
@*                 headers: { 'Content-Type': 'application/json' }, *@
@*                 body: JSON.stringify({ totalAmount: @((int)(totalAmount * 100)) }) // convert to paisa *@
@*             }) *@
@*             .then(res => res.json()) *@
@*             .then(data => { *@
@*                 var options = { *@
@*                     "key": "rzp_test_hXLdzaZ9MkR9Wf", // Replace with your Razorpay key *@
@*                     "amount": @((int)(totalAmount * 100)), *@
@*                     "currency": "INR", *@
@*                     "name": "BoxBuild", *@
@*                     "description": "Purchase Products", *@
@*                     "order_id": data.orderId, *@
@*                     "handler": function (response) { *@
@*                         window.location.href = '/Checkout/PaymentSuccess?paymentId=' + response.razorpay_payment_id; *@
@*                     }, *@
@*                     "prefill": { *@
@*                         "email": "@ViewBag.UserEmail" *@
@*                     }, *@
@*                     "theme": { *@
@*                         "color": "#3399cc" *@
@*                     } *@
@*                 }; *@
@*                 var rzp = new Razorpay(options); *@
@*                 rzp.open(); *@
@*                 e.preventDefault(); *@
@*             }); *@
@*         } *@
@*     </script> *@
@* } *@

@* <!-- Optional: Bootstrap Icons --> *@
@* <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"> *@





<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-header bg-primary text-white rounded-top-4">
                    <h3 class="mb-0">Checkout Summary</h3>
                </div>
                <div class="card-body p-4">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Product</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model)
                                {
                                    var offer = item.Product.ProductOffer?.FirstOrDefault()?.Offer;
                                    decimal price = item.Product.Price;

                                    if (offer != null && offer.StartDate <= DateTime.Now && offer.EndDate >= DateTime.Now)
                                    {
                                        var discountAmount = (offer.DiscountPercentage / 100m) * price;
                                        price -= discountAmount;
                                    }

                                    decimal itemTotal = price * item.Quantity;
                                    totalAmount += itemTotal;

                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <img src="@item.Product.ImagePath" alt="@item.Product.ProductName" style="width: 50px; height: 50px; object-fit: cover; border-radius: 0.5rem; margin-right: 10px;" />
                                                <strong>@item.Product.ProductName</strong>
                                            </div>
                                        </td>
                                        <td>₹@price</td>
                                        <td>@item.Quantity</td>
                                        <td><strong>₹@itemTotal</strong></td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <hr />
                    <div class="d-flex justify-content-between align-items-center">

                        <h4 class="mb-0">Total Amount:</h4>
                        <h4 class="text-success fw-bold">₹@totalAmount.ToString("0.00")</h4>
                    </div>

                    <div class="mt-4">
                        <label>Shipping Address</label>
                        <textarea id="shippingAddress" class="form-control mb-3" required></textarea>

                        <label>Phone Number</label>
                        <input type="text" id="phoneNumber" class="form-control mb-3" required />
                    </div>


                    <div class="text-end mt-4">
                        <button id="rzp-button1" class="btn btn-lg btn-success px-5 py-2 rounded-pill shadow-sm">Pay Now</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@* @section Scripts { *@
@*     <script src="https://checkout.razorpay.com/v1/checkout.js"></script> *@
@*     <script> *@
@*         document.getElementById('rzp-button1').onclick = function (e) { *@
@*             fetch('/Checkout/CreateOrder', { *@
@*                 method: 'POST', *@
@*                 headers: { 'Content-Type': 'application/json' }, *@
@*                 body: JSON.stringify({ totalAmount: @((int)(totalAmount * 100)) }) // amount in paisa *@
@*             }) *@
@*             .then(res => res.json()) *@
@*             .then(data => { *@
@*                 var options = { *@
@*                     "key": "rzp_test_hXLdzaZ9MkR9Wf", // Replace with your Razorpay key *@
@*                     "amount": @((int)(totalAmount * 100)), *@
@*                     "currency": "INR", *@
@*                     "name": "BoxBuild", *@
@*                     "description": "Purchase Products", *@
@*                     "order_id": data.orderId, *@
@*                     "handler": function (response) { *@
@*                         window.location.href = '/Checkout/PaymentSuccess?paymentId=' + response.razorpay_payment_id; *@
@*                     }, *@
@*                     "prefill": { *@
@*                         "email": "@ViewBag.UserEmail" *@
@*                     }, *@
@*                     "theme": { *@
@*                         "color": "#3399cc" *@
@*                     } *@
@*                 }; *@
@*                 var rzp = new Razorpay(options); *@
@*                 rzp.open(); *@
@*                 e.preventDefault(); *@
@*             }); *@
@*         } *@
@*     </script> *@
@* } *@


@section Scripts {
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
        document.getElementById('rzp-button1').onclick = function (e) {
            const address = document.getElementById('shippingAddress').value;
            const phone = document.getElementById('phoneNumber').value;

            if (!address || !phone) {
                alert("Please fill in the address and phone number.");
                return;
            }

            fetch('/Checkout/CreateOrder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    totalAmount: @((int)(totalAmount * 100)), // paisa
                    address: address,
                    phone: phone
                })
            })
            .then(res => res.json())
            .then(data => {
                var options = {
                    "key": "rzp_test_hXLdzaZ9MkR9Wf",
                    "amount": @((int)(totalAmount * 100)),
                    "currency": "INR",
                    "name": "BoxBuild",
                    "description": "Purchase Products",
                    "order_id": data.orderId,
                    "handler": function (response) {
                        window.location.href = '/Checkout/PaymentSuccess?paymentId=' + response.razorpay_payment_id;
                    },
                    "prefill": {
                        "email": "@ViewBag.UserEmail"
                    },
                    "theme": {
                        "color": "#3399cc"
                    }
                };
                var rzp = new Razorpay(options);
                rzp.open();
                e.preventDefault();
            });
        };
    </script>
}
